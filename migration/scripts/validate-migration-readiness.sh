#!/bin/bash
# validate-migration-readiness.sh
# Script de validation compl√®te avant de lancer la migration

set -e

echo "üõ°Ô∏è VALIDATION DE LA PR√âPARATION √Ä LA MIGRATION"
echo "=============================================="
echo "V√©rification compl√®te de l'√©tat du projet avant migration..."

PROJECT_ROOT="$(pwd)"
VALIDATION_LOG="migration/audit/validation-report.log"
VALIDATION_REPORT="migration/audit/validation-report.json"

mkdir -p "$(dirname "$VALIDATION_LOG")"

echo "=== Validation pr√©-migration d√©marr√©e le $(date) ===" > "$VALIDATION_LOG"

# Initialisation du rapport JSON
cat > "$VALIDATION_REPORT" << 'EOF'
{
  "validation_metadata": {
    "timestamp": "",
    "project_root": "",
    "validation_version": "1.0.0"
  },
  "checks": {},
  "summary": {
    "total_checks": 0,
    "passed_checks": 0,
    "failed_checks": 0,
    "warnings": 0,
    "overall_status": "unknown"
  },
  "recommendations": []
}
EOF

# Variables de comptage
TOTAL_CHECKS=0
PASSED_CHECKS=0
FAILED_CHECKS=0
WARNINGS=0

# Fonction pour ajouter un r√©sultat de v√©rification
add_check_result() {
    local check_name="$1"
    local status="$2"
    local message="$3"
    local details="$4"
    
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    
    case "$status" in
        "PASS")
            PASSED_CHECKS=$((PASSED_CHECKS + 1))
            echo "‚úÖ $check_name: $message" | tee -a "$VALIDATION_LOG"
            ;;
        "FAIL")
            FAILED_CHECKS=$((FAILED_CHECKS + 1))
            echo "‚ùå $check_name: $message" | tee -a "$VALIDATION_LOG"
            ;;
        "WARN")
            WARNINGS=$((WARNINGS + 1))
            echo "‚ö†Ô∏è $check_name: $message" | tee -a "$VALIDATION_LOG"
            ;;
    esac
    
    if [ -n "$details" ]; then
        echo "   üìã D√©tails: $details" | tee -a "$VALIDATION_LOG"
    fi
    
    # Ajouter au rapport JSON
    local temp_file=$(mktemp)
    jq ".checks[\"$check_name\"] = {
        \"status\": \"$status\",
        \"message\": \"$message\",
        \"details\": \"$details\",
        \"timestamp\": \"$(date -Iseconds)\"
    }" "$VALIDATION_REPORT" > "$temp_file" && mv "$temp_file" "$VALIDATION_REPORT"
}

echo ""
echo "üîç PHASE 1: V√©rifications des pr√©requis"
echo "======================================="

# V√©rification 1: Node.js et npm
check_nodejs() {
    if command -v node >/dev/null 2>&1; then
        local node_version=$(node --version)
        local major_version=$(echo "$node_version" | cut -d'.' -f1 | sed 's/v//')
        
        if [ "$major_version" -ge 18 ]; then
            add_check_result "nodejs_version" "PASS" "Node.js $node_version est compatible" ""
        else
            add_check_result "nodejs_version" "FAIL" "Node.js $node_version est trop ancien (requis: >= 18)" "Mise √† jour recommand√©e"
        fi
    else
        add_check_result "nodejs_version" "FAIL" "Node.js n'est pas install√©" "Installation requise"
    fi
}

# V√©rification 2: TypeScript
check_typescript() {
    if command -v npx >/dev/null 2>&1 && npx tsc --version >/dev/null 2>&1; then
        local ts_version=$(npx tsc --version)
        add_check_result "typescript_available" "PASS" "TypeScript disponible: $ts_version" ""
    else
        add_check_result "typescript_available" "FAIL" "TypeScript n'est pas disponible" "Installation: npm install -g typescript"
    fi
}

# V√©rification 3: jq pour manipulation JSON
check_jq() {
    if command -v jq >/dev/null 2>&1; then
        local jq_version=$(jq --version)
        add_check_result "jq_available" "PASS" "jq disponible: $jq_version" ""
    else
        add_check_result "jq_available" "FAIL" "jq n'est pas install√©" "Installation requise pour les scripts de migration"
    fi
}

# V√©rification 4: Git pour versioning
check_git() {
    if command -v git >/dev/null 2>&1; then
        if git rev-parse --git-dir >/dev/null 2>&1; then
            local git_status=$(git status --porcelain)
            if [ -z "$git_status" ]; then
                add_check_result "git_clean" "PASS" "R√©pertoire git propre" ""
            else
                add_check_result "git_clean" "WARN" "Modifications non commit√©es d√©tect√©es" "Recommand√© de commiter avant migration"
            fi
        else
            add_check_result "git_repository" "WARN" "Pas un r√©pertoire git" "Recommand√© d'initialiser git pour le versioning"
        fi
    else
        add_check_result "git_available" "WARN" "Git n'est pas install√©" "Recommand√© pour le versioning durant la migration"
    fi
}

echo ""
echo "üîç PHASE 2: V√©rifications de l'√©tat du projet"
echo "============================================="

# V√©rification 5: Compilation actuelle
check_current_compilation() {
    echo "üîÑ Test de compilation actuelle..." | tee -a "$VALIDATION_LOG"
    
    if npx tsc --noEmit >/dev/null 2>&1; then
        add_check_result "current_compilation" "PASS" "Le projet compile sans erreur" ""
    else
        local errors=$(npx tsc --noEmit 2>&1 | head -10)
        add_check_result "current_compilation" "FAIL" "Erreurs de compilation d√©tect√©es" "$errors"
    fi
}

# V√©rification 6: Structure des fichiers src/
check_src_structure() {
    if [ -d "src" ]; then
        local ts_files_count=$(find src -name "*.ts" -o -name "*.tsx" | wc -l)
        add_check_result "src_structure" "PASS" "R√©pertoire src/ trouv√© avec $ts_files_count fichiers TypeScript" ""
    else
        add_check_result "src_structure" "FAIL" "R√©pertoire src/ non trouv√©" "Structure de projet Next.js attendue"
    fi
}

# V√©rification 7: Existence des types AlgorithmLab
check_algorithm_lab_types() {
    local types_found=0
    
    # Chercher les fichiers de types connus
    local common_types=(
        "types/ThesisVariables.ts"
        "types/Level1Types.ts"
        "types/ValidationTypes.ts"
        "types/SharedTypes.ts"
        "types/normalizers.ts"
    )
    
    for type_file in "${common_types[@]}"; do
        if [ -f "src/$type_file" ]; then
            types_found=$((types_found + 1))
        fi
    done
    
    if [ $types_found -gt 0 ]; then
        add_check_result "algorithm_lab_types" "PASS" "$types_found fichiers de types AlgorithmLab trouv√©s" ""
    else
        # Recherche plus large
        local any_types=$(find src -name "*types*.ts" -o -name "*Types*.ts" | wc -l)
        if [ $any_types -gt 0 ]; then
            add_check_result "algorithm_lab_types" "WARN" "Aucun type AlgorithmLab standard, mais $any_types fichiers de types trouv√©s" "Structure non-standard d√©tect√©e"
        else
            add_check_result "algorithm_lab_types" "FAIL" "Aucun fichier de types trouv√©" "Migration non applicable"
        fi
    fi
}

# V√©rification 8: Analyse des imports existants
check_existing_imports() {
    local algorithm_imports=$(grep -r "import.*from.*types" src --include="*.ts" --include="*.tsx" 2>/dev/null | wc -l || echo 0)
    
    if [ $algorithm_imports -gt 0 ]; then
        add_check_result "existing_imports" "PASS" "$algorithm_imports imports de types d√©tect√©s" "Migration n√©cessaire"
    else
        add_check_result "existing_imports" "WARN" "Peu ou pas d'imports de types d√©tect√©s" "V√©rifier la n√©cessit√© de migration"
    fi
}

echo ""
echo "üîç PHASE 3: V√©rifications des scripts de migration"
echo "================================================="

# V√©rification 9: Scripts de migration disponibles
check_migration_scripts() {
    local scripts_dir="migration/scripts"
    local required_scripts=(
        "audit-algorithmlab-types.sh"
        "generate-intelligent-rules.sh"
        "generate-new-types.sh"
        "transform-imports.sh"
    )
    
    local scripts_found=0
    local missing_scripts=""
    
    for script in "${required_scripts[@]}"; do
        if [ -f "$scripts_dir/$script" ]; then
            scripts_found=$((scripts_found + 1))
            if [ -x "$scripts_dir/$script" ]; then
                echo "  ‚úÖ $script (ex√©cutable)" | tee -a "$VALIDATION_LOG"
            else
                echo "  ‚ö†Ô∏è $script (non ex√©cutable)" | tee -a "$VALIDATION_LOG"
                chmod +x "$scripts_dir/$script"
                echo "    üîß Permissions d'ex√©cution ajout√©es" | tee -a "$VALIDATION_LOG"
            fi
        else
            missing_scripts="$missing_scripts $script"
        fi
    done
    
    if [ $scripts_found -eq ${#required_scripts[@]} ]; then
        add_check_result "migration_scripts" "PASS" "Tous les scripts de migration sont disponibles" ""
    else
        add_check_result "migration_scripts" "FAIL" "Scripts manquants:$missing_scripts" "Cr√©er les scripts manquants"
    fi
}

# V√©rification 10: Espace disque suffisant
check_disk_space() {
    local available_space=$(df . | tail -1 | awk '{print $4}')
    local available_mb=$((available_space / 1024))
    
    if [ $available_mb -gt 100 ]; then
        add_check_result "disk_space" "PASS" "${available_mb}MB d'espace disponible" ""
    else
        add_check_result "disk_space" "WARN" "Seulement ${available_mb}MB d'espace disponible" "Au moins 100MB recommand√©s"
    fi
}

echo ""
echo "üîç PHASE 4: V√©rifications des d√©pendances"
echo "========================================="

# V√©rification 11: package.json et d√©pendances
check_dependencies() {
    if [ -f "package.json" ]; then
        # V√©rifier Next.js
        if grep -q "next" package.json; then
            add_check_result "nextjs_project" "PASS" "Projet Next.js d√©tect√©" ""
        else
            add_check_result "nextjs_project" "WARN" "Next.js non d√©tect√© dans package.json" "V√©rifier le type de projet"
        fi
        
        # V√©rifier TypeScript dans les d√©pendances
        if grep -q "typescript" package.json; then
            add_check_result "typescript_dependency" "PASS" "TypeScript configur√© dans les d√©pendances" ""
        else
            add_check_result "typescript_dependency" "WARN" "TypeScript non trouv√© dans package.json" "Ajouter TypeScript aux d√©pendances"
        fi
    else
        add_check_result "package_json" "FAIL" "package.json non trouv√©" "Projet npm/Node.js requis"
    fi
}

# V√©rification 12: Configuration TypeScript
check_tsconfig() {
    if [ -f "tsconfig.json" ]; then
        # V√©rifier la configuration des alias de chemins
        if grep -q "paths" tsconfig.json; then
            add_check_result "typescript_paths" "PASS" "Configuration des chemins TypeScript d√©tect√©e" ""
        else
            add_check_result "typescript_paths" "WARN" "Pas de configuration de chemins dans tsconfig.json" "Recommand√© pour les nouveaux alias @/types/*"
        fi
    else
        add_check_result "tsconfig_exists" "FAIL" "tsconfig.json non trouv√©" "Configuration TypeScript requise"
    fi
}

echo ""
echo "üîç PHASE 5: Recommandations et pr√©paration"
echo "=========================================="

# G√©n√©ration des recommandations bas√©es sur les r√©sultats
generate_recommendations() {
    local recommendations=()
    
    # Recommandations bas√©es sur les √©checs
    if [ $FAILED_CHECKS -gt 0 ]; then
        recommendations+=("üö® CRITIQUE: Corriger les $FAILED_CHECKS √©checs avant de continuer")
    fi
    
    if [ $WARNINGS -gt 0 ]; then
        recommendations+=("‚ö†Ô∏è Examiner les $WARNINGS avertissements pour optimiser la migration")
    fi
    
    # Recommandations sp√©cifiques
    if ! command -v jq >/dev/null 2>&1; then
        recommendations+=("üì¶ Installer jq: sudo apt install jq (Ubuntu) ou brew install jq (macOS)")
    fi
    
    if ! npx tsc --noEmit >/dev/null 2>&1; then
        recommendations+=("üîß Corriger les erreurs TypeScript avant la migration")
    fi
    
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        recommendations+=("üìö Initialiser git pour le versioning: git init")
    fi
    
    if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
        recommendations+=("üíæ Commiter les modifications: git add . && git commit -m 'Pre-migration state'")
    fi
    
    # Recommandations g√©n√©rales
    recommendations+=("üéØ Cr√©er une branche de migration: git checkout -b migration/algorithm-lab-types")
    recommendations+=("üìã Ex√©cuter l'audit complet: ./migration/scripts/audit-algorithmlab-types.sh")
    recommendations+=("ü§ñ G√©n√©rer les r√®gles intelligentes: ./migration/scripts/generate-intelligent-rules.sh")
    
    # Ajouter les recommandations au rapport JSON
    local temp_file=$(mktemp)
    local recommendations_json=$(printf '%s\n' "${recommendations[@]}" | jq -R . | jq -s .)
    jq ".recommendations = $recommendations_json" "$VALIDATION_REPORT" > "$temp_file" && mv "$temp_file" "$VALIDATION_REPORT"
    
    echo "üí° Recommandations g√©n√©r√©es:" | tee -a "$VALIDATION_LOG"
    for rec in "${recommendations[@]}"; do
        echo "   $rec" | tee -a "$VALIDATION_LOG"
    done
}

# Finalisation du rapport
finalize_report() {
    local overall_status="READY"
    
    if [ $FAILED_CHECKS -gt 0 ]; then
        overall_status="NOT_READY"
    elif [ $WARNINGS -gt 3 ]; then
        overall_status="READY_WITH_WARNINGS"
    fi
    
    # Mettre √† jour le rapport final
    local temp_file=$(mktemp)
    jq ".validation_metadata.timestamp = \"$(date -Iseconds)\" |
        .validation_metadata.project_root = \"$PROJECT_ROOT\" |
        .summary.total_checks = $TOTAL_CHECKS |
        .summary.passed_checks = $PASSED_CHECKS |
        .summary.failed_checks = $FAILED_CHECKS |
        .summary.warnings = $WARNINGS |
        .summary.overall_status = \"$overall_status\"" "$VALIDATION_REPORT" > "$temp_file" && mv "$temp_file" "$VALIDATION_REPORT"
}

# =================================================================
# EX√âCUTION DE TOUTES LES V√âRIFICATIONS
# =================================================================

echo "üöÄ D√©marrage des v√©rifications..."

# Phase 1: Pr√©requis
check_nodejs
check_typescript
check_jq
check_git

# Phase 2: √âtat du projet
check_current_compilation
check_src_structure
check_algorithm_lab_types
check_existing_imports

# Phase 3: Scripts de migration
check_migration_scripts
check_disk_space

# Phase 4: D√©pendances
check_dependencies
check_tsconfig

# Phase 5: Recommandations
generate_recommendations
finalize_report

# =================================================================
# RAPPORT FINAL
# =================================================================

echo ""
echo "üìä RAPPORT FINAL DE VALIDATION"
echo "=============================="

local overall_status=$(jq -r '.summary.overall_status' "$VALIDATION_REPORT")

case "$overall_status" in
    "READY")
        echo "‚úÖ STATUT: PR√äT POUR LA MIGRATION"
        echo "üéØ Le projet est pr√™t pour la migration AlgorithmLab"
        ;;
    "READY_WITH_WARNINGS")
        echo "‚ö†Ô∏è STATUT: PR√äT AVEC AVERTISSEMENTS"
        echo "üéØ Migration possible mais optimisations recommand√©es"
        ;;
    "NOT_READY")
        echo "‚ùå STATUT: NON PR√äT"
        echo "üö® Corriger les probl√®mes critiques avant de continuer"
        ;;
esac

echo ""
echo "üìä R√©sum√© des v√©rifications:"
echo "   ‚úÖ R√©ussies: $PASSED_CHECKS/$TOTAL_CHECKS"
echo "   ‚ùå √âchecs: $FAILED_CHECKS/$TOTAL_CHECKS"
echo "   ‚ö†Ô∏è Avertissements: $WARNINGS"

echo ""
echo "üìÅ Fichiers g√©n√©r√©s:"
echo "   üìä Rapport JSON: $VALIDATION_REPORT"
echo "   üìù Log d√©taill√©: $VALIDATION_LOG"

if [ "$overall_status" = "READY" ] || [ "$overall_status" = "READY_WITH_WARNINGS" ]; then
    echo ""
    echo "üöÄ PROCHAINES √âTAPES RECOMMAND√âES:"
    echo "=================================="
    echo "1. üîç Audit complet:"
    echo "   ./migration/scripts/audit-algorithmlab-types.sh"
    echo ""
    echo "2. ü§ñ G√©n√©ration des r√®gles intelligentes:"
    echo "   ./migration/scripts/generate-intelligent-rules.sh"
    echo ""
    echo "3. üèóÔ∏è G√©n√©ration de la nouvelle architecture:"
    echo "   ./migration/scripts/generate-new-types.sh"
    echo ""
    echo "4. üîÑ Transformation des imports:"
    echo "   ./migration/scripts/transform-imports.sh"
    echo ""
    echo "‚è±Ô∏è Dur√©e estim√©e totale: 2h30-3h30"
    echo "üìö Documentation compl√®te dans migration/audit/"
else
    echo ""
    echo "üîß ACTIONS REQUISES AVANT LA MIGRATION:"
    echo "======================================"
    echo "Consultez les recommandations dans $VALIDATION_REPORT"
    echo "Corrigez les probl√®mes critiques et relancez la validation"
fi

echo ""
echo "‚úÖ VALIDATION TERMIN√âE"

# Code de sortie bas√© sur le statut
case "$overall_status" in
    "READY") exit 0 ;;
    "READY_WITH_WARNINGS") exit 0 ;;
    "NOT_READY") exit 1 ;;
esac
