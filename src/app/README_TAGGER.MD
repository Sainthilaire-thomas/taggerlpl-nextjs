# Documentation TaggerLPL - Application Next.js (Version Compl√®te)

## Vue d'ensemble

TaggerLPL est une application Next.js d√©di√©e au tagging et √† l'analyse d'appels. L'application utilise une architecture moderne avec React Server Components et Client Components, optimis√©e pour la performance avec des syst√®mes de cache intelligents et des actions en lot.

## Architecture technique

### Technologies utilis√©es

- **Framework** : Next.js 14+ (App Router)
- **UI** : Material-UI (MUI) + Tailwind CSS
- **Base de donn√©es** : Supabase
- **CRM** : Int√©gration Zoho
- **√âtat global** : React Context API
- **Langue** : Interface en fran√ßais

### Hi√©rarchie des Providers

```typescript
SupabaseProvider (session auth)
‚îú‚îÄ‚îÄ ThemeModeProvider (UI themes)
‚îÇ   ‚îú‚îÄ‚îÄ ZohoProvider (CRM integration)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TaggingDataProvider (business logic)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ GlobalNavbar (navigation)
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Pages
```

## Structure des fichiers principaux

### 1. Page d'accueil (`app/page.tsx`)

```typescript
import { redirect } from "next/navigation";

export default function Home() {
  redirect("/tagging");
  return null;
}
```

**Analyse** : Point d'entr√©e avec redirection automatique vers `/tagging`.

### 2. Layout racine (`app/layout.tsx`)

```typescript
"use client";

import { ReactNode } from "react";
// ... imports des providers et composants

export default function RootLayout({ children }: RootLayoutProps) {
  return (
    <html lang="fr">
      <body>
        <AppRouterCacheProvider>
          <SupabaseProvider>
            <ThemeModeProvider>
              <GlobalNavbar />
              <CssBaseline />
              <ZohoProvider>
                <TaggingDataProvider>{children}</TaggingDataProvider>
              </ZohoProvider>
            </ThemeModeProvider>
          </SupabaseProvider>
        </AppRouterCacheProvider>
      </body>
    </html>
  );
}
```

## Composants principaux

### 1. üöÄ GlobalNavbar - Navigation intelligente am√©lior√©e

**Localisation** : `@/components/layout/GlobalNavbar`

**Fonctionnalit√©s cl√©s** :

- **Navigation adaptative** : Comportement diff√©rent selon le type de page
- **Auto-hide intelligent** : Se masque lors du d√©filement vers le bas
- **Zone de d√©tection** : Zone invisible de 20px en haut pour r√©afficher la navbar
- **Hauteur fixe** : 48px constant pour √©viter les d√©calages

**Pages prot√©g√©es** (avec auto-hide) :

- `/dashboard`, `/calls`, `/tagging`, `/new-tagging`, `/tags/admin`, `/analysis`

### 2. TaggingDataProvider - Gestion d'√©tat globale

**Localisation** : `@/context/TaggingDataContext`

**Mod√®les de donn√©es** :

```typescript
interface Tag {
  id?: number;
  label: string;
  color?: string;
  description?: string;
  family?: string;
  callCount?: number;
  turnCount?: number;
}

interface TaggingCall {
  callid: string;
  is_tagging_call: boolean;
  preparedfortranscript: boolean;
  audiourl: string;
  filename?: string;
  filepath?: string;
  upload?: boolean;
}

interface Word {
  id: number;
  transcriptid: string;
  word: string;
  text: string; // Alias de word
  startTime: number;
  endTime: number;
  speaker: string;
  turn: string;
  index?: number;
}

interface TaggedTurn {
  id: number;
  call_id: string;
  start_time: number;
  end_time: number;
  tag: string;
  verbatim: string;
  next_turn_verbatim: string;
  next_turn_tag?: string;
  speaker: string;
  color: string;
}
```

### 3. üöÄ CallTableList - Interface optimis√©e de gestion des appels

**Localisation** : `@/components/calls/CallTableList`

**Architecture du r√©pertoire** :

```
CallTableList/
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useOptimizedCallData.ts    # Cache intelligent
‚îÇ   ‚îî‚îÄ‚îÄ useBulkActions.ts          # Actions en lot
‚îú‚îÄ‚îÄ CallTableList.tsx              # Composant principal
‚îú‚îÄ‚îÄ CallTableFilters.tsx           # Filtres de recherche
‚îú‚îÄ‚îÄ CallTableRow.tsx               # Ligne optimis√©e
‚îú‚îÄ‚îÄ MobileCallCard.tsx             # Vue mobile
‚îú‚îÄ‚îÄ BulkActionsToolbar.tsx         # Actions en lot
‚îú‚îÄ‚îÄ types.ts                       # Types TypeScript
‚îú‚îÄ‚îÄ utils.ts                       # Utilitaires
‚îî‚îÄ‚îÄ index.ts                       # Exports
```

#### üöÄ Optimisations de performance

**1. Cache intelligent avec `useOptimizedCallData`** :

```typescript
const {
  filteredAndSortedCalls,
  uniqueOrigines,
  filters,
  sortState,
  updateFilters,
  updateSort,
  cacheStats,
  clearCache,
} = useOptimizedCallData({
  taggingCalls,
  cacheTimeout: 30000, // 30 secondes
});
```

**2. Actions en lot avec `useBulkActions`** :

```typescript
const {
  selectedCalls,
  selectedCount,
  isBulkProcessing,
  actions: { selectCall, selectAll, processBulkAction },
} = useBulkActions();
```

### 4. üè∑Ô∏è TagManager - Gestion avanc√©e des tags avec statistiques

**Localisation** : `@/components/tags/TagManager`

**Architecture modulaire** :

```
TagManager/
‚îú‚îÄ‚îÄ TagManager.tsx          # Composant principal
‚îú‚îÄ‚îÄ TagUsageStats.tsx       # Composant de statistiques factoris√©
‚îú‚îÄ‚îÄ types.ts               # Types TypeScript
‚îî‚îÄ‚îÄ utils.ts               # Fonctions utilitaires
```

#### Nouvelles fonctionnalit√©s avanc√©es

**1. Syst√®me de statistiques d'utilisation** :

```typescript
interface TagUsageData {
  totalUsage: number;
  asTag: number;
  asNextTurnTag: number;
  examples: {
    verbatim: string;
    next_turn_verbatim: string;
    call_id: string;
    speaker: string;
    context: "tag" | "next_turn_tag";
  }[];
  speakers: string[];
  callsCount: number;
  avgDuration: number;
}
```

**2. Interface moderne avec boutons d'action** :

- **Bouton Info (üìä)** : Affiche les statistiques d'utilisation
- **Bouton Edit (‚úèÔ∏è)** : √âdition avec statistiques automatiques
- **Bouton Delete (üóëÔ∏è)** : Suppression avec gestion des r√©f√©rences

**3. Composant TagUsageStats factoris√©** :

```typescript
// Composant r√©utilisable avec support th√®me dark/light
interface TagUsageStatsProps {
  tagStatsDisplay: TagStatsDisplay;
  onClose?: () => void;
}

const TagUsageStats: React.FC<TagUsageStatsProps> = ({
  tagStatsDisplay,
  onClose,
}) => {
  const theme = useTheme();

  // Adaptation automatique au th√®me
  const getAdaptiveStyles = () => ({
    mainContainer: {
      backgroundColor:
        theme.palette.mode === "dark"
          ? alpha(theme.palette.background.paper, 0.8)
          : alpha(theme.palette.grey[50], 0.9),
      // ... autres styles adaptatifs
    },
  });
};
```

**4. Fonctionnalit√©s avanc√©es** :

- **Fusion intelligente** : D√©tection automatique des doublons
- **R√©assignation** : Transfert des r√©f√©rences vers un autre tag
- **Nettoyage** : Suppression propre des r√©f√©rences orphelines
- **Suggestions** : Recommandations de tags de remplacement
- **Statistiques compl√®tes** : M√©triques d'utilisation d√©taill√©es

#### Interface utilisateur moderne

**1. Grille responsive par famille** :

```typescript
// Layout adaptatif
const renderTagGrid = (tags: LPLTag[], title: string) => (
  <Box sx={{ marginBottom: 2 }}>
    <Typography variant="subtitle1">{title}</Typography>
    <Box
      sx={{
        display: "grid",
        gridTemplateColumns:
          title === "CLIENT"
            ? "repeat(3, 1fr)"
            : "repeat(auto-fit, minmax(150px, 1fr))",
        gap: "8px",
      }}
    >
      {tags.map((tag) => (
        <Box
          key={tag.id}
          sx={
            {
              /* styles des tags */
            }
          }
        >
          {tag.label}
          {/* Boutons d'action superpos√©s */}
        </Box>
      ))}
    </Box>
  </Box>
);
```

**2. Th√®me adaptatif complet** :

- **Mode sombre** : Arri√®re-plans semi-transparents, couleurs adapt√©es
- **Mode clair** : Contrastes √©lev√©s, couleurs vives
- **Transitions fluides** : Animations coh√©rentes
- **Responsive design** : Adaptation mobile/desktop

### 5. üìä Page `/analysis` - Centre d'Analyse Conversationnelle

**Localisation** : `app/(protected)/analysis/page.tsx`

**Architecture des onglets** :

```
üìä Efficacit√© des Strat√©gies  # Analyse d'impact des strat√©gies
üîÑ Flux Conversationnels     # Diagrammes Sankey interactifs
üìà Statistiques par Famille  # Performances par cat√©gorie de tags
üìã Rapports D√©taill√©s        # G√©n√©ration de rapports PDF
```

#### Composants d'analyse int√©gr√©s

**1. DebugFunnel** - Analyse compl√®te des tags :

```typescript
interface DebugFunnelProps {
  selectedOrigin?: string | null;
}

export default function DebugFunnel({ selectedOrigin }: DebugFunnelProps) {
  // Analyse tous les tags de turntagged
  // Correspondance avec lpltag
  // Statistiques par famille
  // D√©tection des tags manquants
}
```

**2. ImprovedGlobalMetrics** - M√©triques globales :

```typescript
// M√©triques globales du syst√®me
interface GlobalMetrics {
  totalTurntagged: number;
  totalUsage: number;
  totalTags: number;
  tagsInLpltag: number;
  tagsNotInLpltag: number;
  totalFamilies: number;
}
```

#### Gestion des erreurs Material-UI

**Probl√®me Grid r√©solu** :

```typescript
// ‚ùå Ancienne version (erreur TypeScript)
<Grid container spacing={2}>
  <Grid item xs={12} sm={6} md={2}>
    <Card>...</Card>
  </Grid>
</Grid>

// ‚úÖ Solution avec Box (recommand√©e)
<Box sx={{
  display: "flex",
  flexWrap: "wrap",
  gap: 2,
  mb: 3
}}>
  <Box sx={{ flex: "1 1 200px" }}>
    <Card>...</Card>
  </Box>
</Box>
```

### 6. TranscriptLPL - Composant de transcription refactoris√©

**Localisation** : `@/components/TranscriptLPL`

**Architecture modulaire** :

```
TranscriptLPL/
‚îú‚îÄ‚îÄ index.tsx                  # Composant principal
‚îú‚îÄ‚îÄ types.ts                   # Types partag√©s
‚îú‚îÄ‚îÄ TranscriptHeader.tsx       # En-t√™te
‚îú‚îÄ‚îÄ TranscriptAudioPlayer.tsx  # Lecteur audio
‚îú‚îÄ‚îÄ TranscriptControls.tsx     # Contr√¥les
‚îú‚îÄ‚îÄ TranscriptText.tsx         # Affichage du texte
‚îú‚îÄ‚îÄ TagSidePanel.tsx          # Panneau lat√©ral
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useTaggingLogic.ts    # Logique de tagging
‚îÇ   ‚îî‚îÄ‚îÄ useTranscriptAudio.ts # Gestion audio
‚îî‚îÄ‚îÄ README.md                 # Documentation
```

**Fonctionnalit√©s cl√©s** :

- **Synchronisation audio-texte** en temps r√©el
- **Affichage automatique** des tags existants
- **S√©lection de texte** pour nouveau tagging
- **Panneau lat√©ral** r√©tractable (350px)
- **Calcul automatique** des relations `next_turn_tag`

## Flux de donn√©es et optimisations

### 1. Flux de tagging complet

```
1. S√©lection de texte (onMouseUp)
2. Validation des index et timestamps
3. Ouverture du TagSidePanel
4. S√©lection d'un tag
5. Calcul du next_turn_verbatim
6. Sauvegarde avec v√©rification de doublons
7. Mise √† jour optimiste de l'√©tat local
8. Affichage automatique du tag
```

### 2. Flux de gestion des tags

```
1. Affichage des tags par famille
2. Clic sur bouton Info ‚Üí Chargement des statistiques
3. Analyse des r√©f√©rences dans turntagged
4. Calcul des m√©triques d'utilisation
5. Affichage des exemples de verbatims
6. Actions possibles : √©dition, suppression, fusion
```

### 3. Optimisations de performance

**Cache intelligent** :

```typescript
// Cache des donn√©es avec invalidation automatique
const filteredAndSortedCalls = useMemo(() => {
  if (isCacheValid && cacheRef.current) {
    statsRef.current.hits++;
    return cacheRef.current.data;
  }

  const filtered = filterCalls(taggingCalls, ...);
  const sorted = filtered.sort(getComparator(...));

  cacheRef.current = {
    lastUpdate: Date.now(),
    data: sorted,
    filters: { ...filters },
    sort: { ...sortState },
  };

  return sorted;
}, [taggingCalls, filters, sortState, isCacheValid]);
```

**M√©mo√Øsation strat√©gique** :

- Composants `React.memo()` pour √©viter les re-renders
- Handlers `useCallback` pour la stabilit√©
- Calculs co√ªteux avec `useMemo`
- **Composants factoris√©s** pour la r√©utilisabilit√©

## Base de donn√©es Supabase

### Tables principales

```sql
-- Appels
call (callid, filename, filepath, upload, duree, status, origine, description)

-- Transcription
transcript (callid, transcriptid)
word (transcriptid, word, startTime, endTime, speaker, turn)

-- Tags
lpltag (label, color, description, family, originespeaker, icon)
turntagged (call_id, start_time, end_time, tag, verbatim, next_turn_verbatim, speaker, next_turn_tag)

-- Audit
tag_modifications (action, old_tag, new_tag, modified_at, modified_by, previous_data)
```

### Relations cruciales

**Correspondance tags-usage** :

```sql
-- Requ√™te pour les statistiques d'utilisation
SELECT
  id, call_id, verbatim, next_turn_verbatim, speaker,
  start_time, end_time, tag, next_turn_tag
FROM turntagged
WHERE tag = 'label_du_tag' OR next_turn_tag = 'label_du_tag'
ORDER BY call_id
LIMIT 100;
```

### S√©curit√©

- **Row Level Security** (RLS) sur toutes les tables
- **URLs sign√©es** pour fichiers audio (20 min par d√©faut)
- **Authentification** obligatoire via `ProtectedRoute`

## Gestion des erreurs et bonnes pratiques

### 1. Gestion des conflits TypeScript

**Conflits de noms** :

```typescript
// ‚ùå Probl√®me : Conflit interface/composant
interface TagUsageStats { ... }
import TagUsageStats from "./TagUsageStats";

// ‚úÖ Solution : Renommer l'interface
interface TagUsageData { ... }
import TagUsageStats from "./TagUsageStats";
```

**Props optionnelles** :

```typescript
// ‚úÖ Composant avec props optionnelles
interface ComponentProps {
  selectedOrigin?: string | null;
  onClose?: () => void;
}

const Component: React.FC<ComponentProps> = ({ selectedOrigin, onClose }) => {
  // Gestion des props optionnelles
  useEffect(() => {
    if (selectedOrigin) {
      // Logique sp√©cifique
    }
  }, [selectedOrigin]);
};
```

### 2. Gestion des versions Material-UI

**Probl√®me Grid** :

```typescript
// ‚ùå Probl√®me avec Grid item
<Grid item xs={12} sm={6} md={2}>

// ‚úÖ Solution 1 : Grid2
import { Grid2 as Grid } from "@mui/material";

// ‚úÖ Solution 2 : Box + Flexbox (recommand√©e)
<Box sx={{ display: "flex", flexWrap: "wrap", gap: 2 }}>
  <Box sx={{ flex: "1 1 200px" }}>
    <Card>...</Card>
  </Box>
</Box>
```

### 3. Factorisation et r√©utilisabilit√©

**Composants factoris√©s** :

```typescript
// Structure recommand√©e
ComponentName/
‚îú‚îÄ‚îÄ index.ts                    # Export principal
‚îú‚îÄ‚îÄ ComponentName.tsx           # Composant principal
‚îú‚îÄ‚îÄ SubComponent.tsx            # Sous-composants
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useComponentLogic.ts    # Logique m√©tier
‚îú‚îÄ‚îÄ types.ts                    # Types TypeScript
‚îî‚îÄ‚îÄ utils.ts                    # Utilitaires
```

## Diff√©rences entre les versions

### Version moderne (`/calls` + `/new-tagging` + `/analysis`)

‚úÖ **Avantages** :

- Interface optimis√©e avec cache intelligent
- Actions en lot pour la gestion d'origine
- Feedback temps r√©el et gestion d'erreurs
- Responsive design avec cartes mobiles
- Chargement automatique des tags
- **Centre d'analyse conversationnelle complet**
- **G√©n√©ration de rapports PDF**
- **Visualisations interactives**
- **Gestion avanc√©e des tags avec statistiques**
- **Composants factoris√©s et r√©utilisables**
- **Support complet th√®me dark/light**

### Version classique (`/tagging`)

‚ö†Ô∏è **Limitations** :

- Interface tout-en-un plus lourde
- Pas d'optimisations de performance
- Chargement via accordion moins intuitif
- Pas d'actions en lot
- **Aucune fonctionnalit√© d'analyse avanc√©e**
- **Pas de statistiques d'utilisation des tags**
- **Interface moins moderne**

## Recommandations techniques

### Points forts √† maintenir

1. **Cache intelligent** pour les performances
2. **Syst√®me d'audit** tr√®s professionnel
3. **Architecture modulaire** facilite la maintenance
4. **Types TypeScript** complets et coh√©rents
5. **Correspondance des speakers** robuste
6. **Syst√®me next_turn_verbatim** intelligent
7. **Centre d'analyse** complet avec visualisations
8. **Interface responsive** moderne
9. **Composants factoris√©s** r√©utilisables
10. **Support th√®me adaptatif** complet

### Am√©liorations sugg√©r√©es

1. **Tests unitaires** pour les hooks complexes
2. **Error boundaries** explicites
3. **Monitoring** des performances en production
4. **Documentation JSDoc** pour les fonctions complexes
5. **Extensibilit√©** du syst√®me d'actions en lot
6. **API d'export** pour les rapports d'analyse
7. **Filtres temporels** pour l'analyse des tendances
8. **Syst√®me de cache** pour les statistiques de tags
9. **Notifications** en temps r√©el pour les modifications
10. **Tests d'int√©gration** pour les flux critiques

### Bonnes pratiques impl√©ment√©es

1. **Cache multi-niveaux** avec statistiques
2. **Validation robuste** des donn√©es utilisateur
3. **Feedback imm√©diat** avec √©tats visuels
4. **Gestion d'erreurs** granulaire
5. **Interface responsive** moderne
6. **S√©paration des pr√©occupations** entre tagging et analyse
7. **Syst√®me de navigation** intelligent
8. **Factorisation** des composants complexes
9. **Gestion des conflits** TypeScript
10. **Adaptation th√©matique** automatique

## D√©veloppements r√©cents (Session actuelle)

### 1. TagManager avec statistiques d'utilisation

- **Nouveau composant TagUsageStats** factoris√©
- **Interface moderne** avec boutons d'action
- **Statistiques compl√®tes** d'utilisation des tags
- **Exemples de verbatims** pour chaque tag
- **Gestion des r√©f√©rences** lors de la suppression
- **Support th√®me dark/light** complet

### 2. Corrections techniques

- **R√©solution des conflits** TypeScript (TagUsageStats)
- **Correction des erreurs** Material-UI Grid
- **Props optionnelles** pour les composants
- **Gestion des versions** MUI compatibles

### 3. Am√©liorations UX

- **Feedback visuel** pour les actions
- **Chargement progressif** des statistiques
- **Interface responsive** optimis√©e
- **Transitions fluides** entre les √©tats

---

## Notes importantes pour la prochaine session

### üìã √âtat actuel du projet

**Fonctionnalit√©s op√©rationnelles** :

- ‚úÖ Syst√®me de tagging complet et moderne
- ‚úÖ Gestion avanc√©e des tags avec statistiques
- ‚úÖ Interface d'analyse conversationnelle
- ‚úÖ Cache intelligent et optimisations
- ‚úÖ Support th√®me dark/light
- ‚úÖ Composants factoris√©s r√©utilisables

**Composants cl√©s d√©velopp√©s** :

- ‚úÖ `TagManager` avec statistiques avanc√©es
- ‚úÖ `TagUsageStats` factoris√© avec th√®me adaptatif
- ‚úÖ `DebugFunnel` pour analyse compl√®te
- ‚úÖ `CallTableList` avec cache intelligent
- ‚úÖ `TranscriptLPL` avec logique de tagging

### üîß Points d'attention technique

1. **Gestion des types** : √âviter les conflits interface/composant
2. **Versions MUI** : Utiliser Box+Flexbox plut√¥t que Grid
3. **Props optionnelles** : Toujours d√©finir les interfaces compl√®tes
4. **Cache** : Surveiller les performances avec de gros volumes
5. **Correspondance speakers** : Peut n√©cessiter des ajustements

### üìä Structure de donn√©es critiques

```typescript
// Table turntagged (cruciale pour l'analyse)
interface TurnTagged {
  call_id: string;
  tag: string; // Tag principal
  next_turn_tag: string; // Tag du tour suivant
  verbatim: string; // Texte de ce tour
  next_turn_verbatim: string; // Texte du tour suivant
  speaker: string; // Qui parle
  start_time: number;
  end_time: number;
}

// Table lpltag (r√©f√©rentiel des tags)
interface LPLTag {
  id: number;
  label: string; // Nom du tag
  family: string; // Famille (ENGAGEMENT, REFLET, etc.)
  originespeaker: string; // conseiller/client
  color: string; // Couleur d'affichage
  icon: string; // Ic√¥ne optionnelle
  description: string; // Description
}
```

### üéØ Prochaines √©tapes sugg√©r√©es

1. **Tests unitaires** pour les hooks complexes
2. **Monitoring** des performances en production
3. **Documentation** des API internes
4. **Filtres temporels** pour l'analyse
5. **Export** des rapports d'analyse
6. **Notifications** temps r√©el
7. **Int√©gration** avec d'autres syst√®mes

Cette application est un **syst√®me de tagging conversationnel tr√®s sophistiqu√©** avec **centre d'analyse avanc√©** et **gestion intelligente des tags** . L'architecture modulaire et les optimisations de performance en font une solution robuste et √©volutive.
